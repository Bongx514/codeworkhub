@page
@model Codeworkhub.Pages.Apps.TypeFast.TypefastModel
@{
}

<form id="scoreForm" method="post">
    <input type="hidden" name="CorrectWords" id="correctWordsInput" />
</form>

<div class="min-h-screen bg-gradient-to-br from-black via-slate-900 to-indigo-900 text-white flex items-center justify-center p-8">
    <div class="w-full max-w-3xl bg-slate-800/50 backdrop-blur-xl p-10 rounded-2xl border border-indigo-500/40 shadow-2xl">

        <h1 class="text-center text-3xl font-bold mb-6 tracking-widest text-indigo-300">
            <i class="fa-solid fa-keyboard"></i> TYPING SPEED TEST
        </h1>

        <p class="text-center text-xl font-bold mb-6">
            Time Left: <span id="timer" class="text-yellow-400 text-3xl">60</span>
        </p>

        <div class="flex justify-center mb-6">
            <div id="currentWord"
                 class="text-4xl font-bold tracking-widest p-4 rounded-xl bg-black border border-indigo-400"></div>
        </div>

        <input id="inputBox"
               class="w-full p-4 rounded-xl bg-black text-xl border border-indigo-500 outline-none focus:ring-4 ring-indigo-600"
               placeholder="Start typing..."
               oninput="checkInput()" autofocus />

        <button id="restartBtn"
                onclick="restartTest()"
                class="hidden mt-5 w-full py-3 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-lg font-bold transition-all">
            <i class="fa-solid fa-rotate-right"></i> Restart
        </button>
    </div>
</div>

@if (Model.ShowResult)
{
    <div class="fixed inset-0 bg-black/90 flex items-center justify-center z-50">
        <div class="bg-slate-800 text-center p-10 rounded-2xl border border-indigo-500 shadow-xl max-w-md w-full">
            <h2 class="text-3xl font-bold mb-4 text-indigo-300"><i class="fa-solid fa-award"></i> Results</h2>
            <p class="text-xl text-gray-300 mb-2">WPM: <span class="font-bold text-yellow-400">@Model.WPM</span></p>
            <p class="text-xl text-gray-300 mb-2">Accuracy: <span class="font-bold text-yellow-400">@Model.Accuracy%</span></p>
            <p class="text-xl text-gray-300 mb-6">Correct Words: <span class="font-bold text-indigo-300">@Model.CorrectWords</span></p>

            <a href="/Apps/Typefast/Typefast"
               class="block bg-indigo-600 mt-5 py-3 rounded-xl font-bold hover:bg-indigo-700">
                TRY AGAIN
            </a>
        </div>
    </div>
}

<script>
    let words = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Words));
    let index = 0, timeLeft = 60, timerStarted = false, typedCorrect = 0;

    document.getElementById("currentWord").innerText = words[index];

    function checkInput() {
        let box = document.getElementById("inputBox");
        let entered = box.value;
        let target = words[index];

        if (!timerStarted) startTimer();

        let output = "";
        for (let i = 0; i < target.length; i++) {
            if (entered[i] == null) output += `<span>${target[i]}</span>`;
            else if (entered[i] === target[i]) output += `<span style='color:#4ade80'>${target[i]}</span>`;
            else output += `<span style='color:#ef4444'>${target[i]}</span>`;
        }
        document.getElementById("currentWord").innerHTML = output;

        if (entered.endsWith(" ")) {
            if (entered.trim() === target) typedCorrect++;
            box.value = "";
            index = (index + 1) % words.length;
            document.getElementById("currentWord").innerText = words[index];
        }
    }

    function startTimer() {
        timerStarted = true;
        const interval = setInterval(() => {
            timeLeft--;
            document.getElementById("timer").innerText = timeLeft;
            if (timeLeft <= 0) {
                clearInterval(interval);
                document.getElementById("inputBox").disabled = true;
                document.getElementById("correctWordsInput").value = typedCorrect;
                document.getElementById("scoreForm").submit();
            }
        }, 1000);
    }

    function restartTest() {
        window.location.reload();
    }
</script>